"""
LangChain Tools –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API "–Ø –ó–¥–µ—Å—å –ñ–∏–≤—É"
"""

import json
import logging

from langchain_core.tools import tool

# –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤—ã–∑–æ–≤–æ–≤ tools
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ª–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
_client = None


def _get_client():
    """
    –ü–æ–ª—É—á–∞–µ—Ç singleton –∫–ª–∏–µ–Ω—Ç–∞ API
    """
    global _client
    if _client is None:
        from app.api.yazz import CityAppClient

        _client = CityAppClient()
    return _client


@tool
def find_nearest_mfc_tool(address: str) -> str:
    """
    –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π –ú–§–¶ (–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä) –ø–æ –∞–¥—Ä–µ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
    - –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–ª–∏–∂–∞–π—à–∏–π –ú–§–¶?
    - –ö–∞–∫ –Ω–∞–π—Ç–∏ –ú–§–¶ —Ä—è–¥–æ–º —Å –º–æ–∏–º –¥–æ–º–æ–º?
    - –ê–¥—Ä–µ—Å –ú–§–¶ –æ–∫–æ–ª–æ [–∞–¥—Ä–µ—Å]
    - –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –ú–§–¶

    Args:
        address: –ê–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç 1" –∏–ª–∏ "–ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤ 68")

    Returns:
        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–∏–∂–∞–π—à–µ–º –ú–§–¶ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã)
    """
    logger.info(f'üîß [TOOL CALL] find_nearest_mfc_tool(address="{address}")')

    client = _get_client()
    result = client.find_nearest_mfc(address)

    if result is None:
        logger.warning(f'‚ö†Ô∏è [TOOL RESULT] –ú–§–¶ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∞–¥—Ä–µ—Å–∞: {address}')
        return '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ú–§–¶ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å.'

    logger.info(f'‚úÖ [TOOL RESULT] –ù–∞–π–¥–µ–Ω –ú–§–¶: {result.get("name", "N/A")}')
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_pensioner_categories_tool() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤

    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
    - –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –µ—Å—Ç—å –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤?
    - –ö–∞–∫–∏–µ –∫—Ä—É–∂–∫–∏/—Å–µ–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∂–∏–ª—ã—Ö?
    - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤

    Returns:
        –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤
    """
    logger.info('üîß [TOOL CALL] get_pensioner_categories_tool()')

    client = _get_client()
    result = client.pensioner_service_category()

    if result is None:
        logger.warning('‚ö†Ô∏è [TOOL RESULT] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')
        return '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥.'

    logger.info(f'‚úÖ [TOOL RESULT] –ü–æ–ª—É—á–µ–Ω–æ {len(result) if isinstance(result, list) else 1} –∫–∞—Ç–µ–≥–æ—Ä–∏–π')
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_pensioner_services_tool(district: str, categories: str) -> str:
    """
    –ù–∞–π—Ç–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ –ø–æ —Ä–∞–π–æ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
    - –ö–∞–∫–∏–µ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ –µ—Å—Ç—å –≤ [—Ä–∞–π–æ–Ω]?
    - –ì–¥–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –∫—É—Ä—Å—ã –¥–ª—è –ø–æ–∂–∏–ª—ã—Ö?
    - –ö—Ä—É–∂–∫–∏ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ –≤ –ù–µ–≤—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ

    Args:
        district: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ù–µ–≤—Å–∫–∏–π", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π")
        categories: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–í–æ–∫–∞–ª,–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –∫—É—Ä—Å—ã")

    Returns:
        –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ä–∞–π–æ–Ω–µ
    """
    logger.info(f'üîß [TOOL CALL] get_pensioner_services_tool(district="{district}", categories="{categories}")')

    client = _get_client()
    category_list = [c.strip() for c in categories.split(',')]
    result = client.pensioner_services(district, category_list)

    if result is None:
        logger.warning(f'‚ö†Ô∏è [TOOL RESULT] –£—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —Ä–∞–π–æ–Ω–∞ {district}')
        return '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É—Å–ª—É–≥–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.'

    logger.info(f'‚úÖ [TOOL RESULT] –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥: {len(result) if isinstance(result, list) else 1}')
    return json.dumps(result, ensure_ascii=False, indent=2)


# —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
ALL_TOOLS = [
    find_nearest_mfc_tool,
    get_pensioner_categories_tool,
    get_pensioner_services_tool,
]
