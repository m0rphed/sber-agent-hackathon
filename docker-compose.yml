# ══════════════════════════════════════════════════════════════════════════════
# Docker Compose - Цифровой Ассистент Санкт-Петербурга
# Sber Agent Hackathon 2025
# ══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # LangGraph Server - Основной API с графами агента
  # ═══════════════════════════════════════════════════════════════════════════
  langgraph:
    build:
      context: .
      dockerfile: docker/langgraph.Dockerfile
    container_name: spb-langgraph
    ports:
      - "${LANGGRAPH_PORT:-2024}:2024"
    environment:
      # GigaChat
      - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
      - GIGACHAT_SCOPE=${GIGACHAT_SCOPE:-GIGACHAT_API_PERS}
      - GIGACHAT_MODEL=${GIGACHAT_MODEL:-GigaChat-2-Max}
      - GIGACHAT_VERIFY_SSL_CERTS=${GIGACHAT_VERIFY_SSL_CERTS:-false}
      - EMBEDDINGS_MODEL=${EMBEDDINGS_MODEL:-EmbeddingsGigaR}
      # RAG
      - CHUNK_SIZE=${CHUNK_SIZE:-800}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - TOP_K=${TOP_K:-5}
      - RAG_USE_QUERY_REWRITING=${RAG_USE_QUERY_REWRITING:-true}
      - RAG_USE_DOCUMENT_GRADING=${RAG_USE_DOCUMENT_GRADING:-true}
      # City API
      - API_GEO=${API_GEO:-https://yazzh-geo.gate.petersburg.ru}
      - API_SITE=${API_SITE:-https://yazzh.gate.petersburg.ru}
      - REGION_ID=${REGION_ID:-78}
      # Yandex
      - YANDEX_API_KEY=${YANDEX_API_KEY}
      # LangSmith
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY}
      - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-city-assistant}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - IS_DEBUG=${IS_DEBUG:-false}
    volumes:
      - langgraph-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - spb-network

  # ═══════════════════════════════════════════════════════════════════════════
  # Streamlit UI - Веб-интерфейс чата
  # ═══════════════════════════════════════════════════════════════════════════
  streamlit:
    build:
      context: .
      dockerfile: docker/streamlit.Dockerfile
    container_name: spb-streamlit
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    environment:
      - LANGGRAPH_URL=http://langgraph:2024
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      langgraph:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - spb-network

  # ═══════════════════════════════════════════════════════════════════════════
  # Telegram Bot - Бот для Telegram
  # ═══════════════════════════════════════════════════════════════════════════
  bot-telegram:
    build:
      context: .
      dockerfile: docker/bot-telegram.Dockerfile
    container_name: spb-telegram-bot
    environment:
      - TOKEN_TG=${TOKEN_TG}
      - LANGGRAPH_URL=http://langgraph:2024
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      langgraph:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - spb-network
    profiles:
      - bots
      - telegram

  # ═══════════════════════════════════════════════════════════════════════════
  # MAX Bot - Бот для MAX/VK Teams
  # ═══════════════════════════════════════════════════════════════════════════
  bot-max:
    build:
      context: .
      dockerfile: docker/bot-max.Dockerfile
    container_name: spb-max-bot
    environment:
      - TOKEN_MAX=${TOKEN_MAX}
      - LANGGRAPH_URL=http://langgraph:2024
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      langgraph:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - spb-network
    profiles:
      - bots
      - max

# ═══════════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  spb-network:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════════════════
# Volumes
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  langgraph-data:
    driver: local
