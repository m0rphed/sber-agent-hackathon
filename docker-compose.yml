# ══════════════════════════════════════════════════════════════
# City Assistant - Docker Compose
# ══════════════════════════════════════════════════════════════
#
# Запуск всех сервисов:
#   docker compose up -d
#
# Запуск только API:
#   docker compose up langgraph-api -d
#
# Логи:
#   docker compose logs -f langgraph-api
#
# ══════════════════════════════════════════════════════════════

services:
  # ════════════════════════════════════════════════════════════
  # LangGraph API - основной бэкенд с агентом
  # ════════════════════════════════════════════════════════════
  langgraph-api:
    build:
      context: .
      dockerfile: packages/langgraph-app/Dockerfile
    container_name: city-assistant-api
    ports:
      - "2024:2024"
    env_file:
      - packages/langgraph-app/.env
    volumes:
      - ./data:/app/data:ro
      - ./prompts:/app/prompts:ro
      - langgraph-cache:/app/cache
    networks:
      - city-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ════════════════════════════════════════════════════════════
  # Streamlit UI - веб-интерфейс
  # ════════════════════════════════════════════════════════════
  streamlit:
    build:
      context: .
      dockerfile: packages/streamlit-ui/Dockerfile
    container_name: city-assistant-ui
    ports:
      - "8501:8501"
    env_file:
      - packages/streamlit-ui/.env
    environment:
      - LANGGRAPH_API_URL=http://langgraph-api:2024
    depends_on:
      langgraph-api:
        condition: service_healthy
    networks:
      - city-net
    restart: unless-stopped

  # ════════════════════════════════════════════════════════════
  # Telegram Bot
  # ════════════════════════════════════════════════════════════
  bot-telegram:
    build:
      context: .
      dockerfile: packages/bot-telegram/Dockerfile
    container_name: city-assistant-tg
    env_file:
      - packages/bot-telegram/.env
    environment:
      - LANGGRAPH_API_URL=http://langgraph-api:2024
    depends_on:
      langgraph-api:
        condition: service_healthy
    networks:
      - city-net
    restart: unless-stopped

  # ════════════════════════════════════════════════════════════
  # MAX Bot
  # ════════════════════════════════════════════════════════════
  bot-max:
    build:
      context: .
      dockerfile: packages/bot-max/Dockerfile
    container_name: city-assistant-max
    env_file:
      - packages/bot-max/.env
    environment:
      - LANGGRAPH_API_URL=http://langgraph-api:2024
    depends_on:
      langgraph-api:
        condition: service_healthy
    networks:
      - city-net
    restart: unless-stopped

# ══════════════════════════════════════════════════════════════
# Volumes
# ══════════════════════════════════════════════════════════════
volumes:
  langgraph-cache:
    driver: local

# ══════════════════════════════════════════════════════════════
# Networks
# ══════════════════════════════════════════════════════════════
networks:
  city-net:
    driver: bridge
